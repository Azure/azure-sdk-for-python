parameters:
- name: release_azure_core
  displayName: 'azure-core'
  type: boolean
  default: true
- name: release_azure_storage
  displayName: 'azure-storage'
  type: boolean
  default: true
  # continue to add for each of the possible packages

variables:
  - template: /eng/pipelines/templates/variables/globals.yml

stages:
  - stage: Build_Dependencies
    displayName: Build Platform-Specific Binary Conda Packages
    jobs:
    - template: ../jobs/build-conda-dependencies.yml
      parameters:
        CondaArtifacts:
        - name: azure-core
          common_root: azure
          service: core
          in_batch: true
          checkout:
          - package: azure-core
            download_uri: https://files.pythonhosted.org/packages/df/d4/1472562806c1cef919503207082c2b2be70d005cd6deb9ae46d4af0c1b4a/azure-core-1.29.1.zip
          - package: azure-mgmt-core
            download_uri: https://files.pythonhosted.org/packages/14/95/2b2085e40f4b9de88ad256428a669583066d8ab348fc19110c7d04c3189b/azure-mgmt-core-1.4.0.zip
          - package: azure-common
            download_uri: https://files.pythonhosted.org/packages/3e/71/f6f71a276e2e69264a97ad39ef850dca0a04fce67b12570730cb38d0ccac/azure-common-1.1.28.zip
        - name: msrest
          in_batch: true
          checkout:
          - package: msrest
            download_uri: https://files.pythonhosted.org/packages/68/77/8397c8fb8fc257d8ea0fa66f8068e073278c65f05acb17dcb22a02bfdc42/msrest-0.7.1.zip
        - name: msal
          in_batch: true
          checkout:
          - package: msal
            download_uri: https://files.pythonhosted.org/packages/85/9b/cf94ca59e4d88afe1852962d2b7e0cd9cee752dddf7cd6e30382cdc3f7ed/msal-1.23.0.tar.gz
        - name: uamqp
          common_root: uamqp
          in_batch: true
          checkout:
          - package: uamqp
            download_uri: https://files.pythonhosted.org/packages/0b/d8/fc24d95e6f6c80851ae6738c78da081cd535c924b02c5a4928b108b9ed42/uamqp-1.6.5.tar.gz
        - name: msal-extensions
          common_root: msal
          in_batch: true
          checkout:
          - package: msal-extensions
            download_uri: https://files.pythonhosted.org/packages/33/5e/2e23593c67df0b21ffb141c485ca0ae955569203d7ff5064040af968cb81/msal-extensions-1.0.0.tar.gz

  - stage: Build_Universal_Dependencies
    displayName: Build Universal Conda Packages
    dependsOn: Build_Dependencies
    jobs:
    - job: 'Build'
      timeoutInMinutes: 90
        
      pool:
        name: azsdk-pool-mms-ubuntu-2004-general
        vmImage: MMSUbuntu20.04

      steps:
        - download: current
          artifact: windows_conda
          timeoutInMinutes: 5

        - download: current
          artifact: linux_conda
          timeoutInMinutes: 5

        - download: current
          artifact: mac_conda
          timeoutInMinutes: 5

        - template: ../steps/build-conda-artifacts.yml
          parameters:
            Arguments: '--channel "$(Pipeline.Workspace)/mac_conda" "$(Pipeline.Workspace)/windows_conda" "$(Pipeline.Workspace)/linux_conda"'
            CondaArtifacts:
              - name: azure-core
                common_root: azure
                service: core
                in_batch: true
                checkout:
                - package: azure-core
                  download_uri: https://files.pythonhosted.org/packages/df/d4/1472562806c1cef919503207082c2b2be70d005cd6deb9ae46d4af0c1b4a/azure-core-1.29.1.zip
                - package: azure-mgmt-core
                  download_uri: https://files.pythonhosted.org/packages/14/95/2b2085e40f4b9de88ad256428a669583066d8ab348fc19110c7d04c3189b/azure-mgmt-core-1.4.0.zip
                - package: azure-common
                  download_uri: https://files.pythonhosted.org/packages/3e/71/f6f71a276e2e69264a97ad39ef850dca0a04fce67b12570730cb38d0ccac/azure-common-1.1.28.zip
              - name: azure-keyvault
                common_root: azure/keyvault
                in_bach: ${{ parameters.release_azure_keyvault }}
                checkout:
                - azure-keyvault-administration-4.3.0
                - azure-keyvault-certificates-4.7.0
                - azure-keyvault-keys-4.8.0
                - azure-keyvault-secrets-4.7.0
              - name: azure-storage
                common_root: azure/storage
                in_batch: ${{ parameters.release_azure_storage }}
                service: storage
                checkout:
                - package: azure-storage-blob
                  checkout_path: sdk/storage
                  version: 12.12.0
                - package: azure-storage-queue
                  checkout_path: sdk/storage
                  version: 12.3.0
                - package: azure-storage-file-share
                  checkout_path: sdk/storage
                  version: 12.8.0
                - package: azure-storage-file-datalake
                  checkout_path: sdk/storage
                  version: 12.7.0
              - name: azure-ai-formrecognizer
                common_root: azure
                service: formrecognizer
                checkout:
                - package: azure-ai-formrecognizer
                  download_uri: https://files.pythonhosted.org/packages/55/f6/4ab4c197d6eb9c83814a7f169c4b26cb1ae360a5f10dac81cccb6b7a00c3/azure-ai-formrecognizer-3.2.1.zip
              - name: azure-ai-language-conversations
                common_root: azure
                service: cognitivelanguage
                checkout:
                - package: azure-ai-language-conversations
                  download_uri: https://files.pythonhosted.org/packages/46/fb/0d1a4186717655ab190c0b0108e1c26fc11e62b13bf105cd1316aa0489ce/azure-ai-language-conversations-1.0.0.zip
              - name: azure-ai-language-questionanswering
                service: cognitivelanguage
                checkout:
                - package: azure-ai-language-questionanswering
                  download_uri: https://files.pythonhosted.org/packages/88/b5/abd1acfaba2b60cb437ba3c9c888c6f98e2eb99b8e9c8376a882120e2945/azure-ai-language-questionanswering-1.1.0.zip
              - name: azure-ai-metricsadvisor
                service: cognitivelanguage
                checkout:
                - package: azure-ai-metricsadvisor
                  download_uri: https://files.pythonhosted.org/packages/f0/03/16532aaeede7abc3a36f6693c1b8b9462dab82d470cffef8d90746615fd7/azure-ai-metricsadvisor-1.0.0.zip
              - name: azure-ai-ml
                service: ml
                checkout:
                - package: azure-ai-ml
                  download_uri: https://files.pythonhosted.org/packages/61/61/c50f2244e09000c101f29a23a585c96e7342693dc9a28064bd70eab82aa3/azure-ai-ml-1.7.2.zip
              - name: azure-ai-textanalytics
                service: textanalytics
                checkout:
                - package: azure-ai-textanalytics
                  download_uri: https://files.pythonhosted.org/packages/3a/7b/ea7ae656769d6b8f11731532c46cb65372c5fe5c18a31eef26c88c7b2f5e/azure-ai-textanalytics-5.2.1.zip
              - name: azure-ai-translation-document
                service: translation
                checkout:
                - package: azure-ai-translation-document
                  download_uri: https://files.pythonhosted.org/packages/3a/09/b12960e87cd52fe3893dc395154b42469a4103345bcf8ef28538f6d64ce9/azure-ai-translation-document-1.0.0.zip 
              - name: azure-appconfiguration
                service: appconfiguration
                checkout:
                - package: azure-appconfiguration
                  download_uri: https://files.pythonhosted.org/packages/77/18/3d95b3ca4aec25070c4f0baaf355d5a537eaaa4e93f0fbc3ab0dbad0e1ce/azure-appconfiguration-1.4.0.zip
              - name: azure-communication
                service: communication
                checkout:
                - package: azure-communication-chat
                  download_uri: https://files.pythonhosted.org/packages/b5/5b/3c38c0f07f50f1a7877f088a63b27733fa36ca835609459bcf0aefec2571/azure-communication-chat-1.1.0.zip
                - package: azure-communication-email
                  download_uri: https://files.pythonhosted.org/packages/4c/fc/45a122a7d6b2cc4652aa9c5ce3a151161433447361af98f15e82cae63727/azure-communication-email-1.0.0.zip
                - package: azure-communication-identity
                  download_uri: https://files.pythonhosted.org/packages/f0/b2/21ab355a1db459aabc2c0f7ab431f6577c0c3b6b88d9992548f367b567e0/azure-communication-identity-1.3.1.zip
                - package: azure-communication-phonenumbers
                  download_uri: https://files.pythonhosted.org/packages/19/6b/7e8f06bc56c385866c69b736bfcef7748af748783c8434ec38d643339a4b/azure-communication-phonenumbers-1.1.0.zip
                - package: azure-communication-sms-1.0.1
                  download_uri: https://files.pythonhosted.org/packages/a2/20/81b03d82c1240b2ee4784e413fb49393b871f78b4e935d7746875a10f8d7/azure-communication-sms-1.0.1.zip
              - name: azure-confidentialledger
                service: confidentialledger
                checkout:
                - package: azure-confidentialledger
                  download_uri: https://files.pythonhosted.org/packages/a1/57/853726be83f065e5f7d21f9a0ebfca8bc2dd4132a5fece47b7d9df0e033a/azure-confidentialledger-1.1.0.zip
              - name: azure-containerregistry
                service: containerregistry
                checkout: 
                - package: azure-containerregistry
                  download_uri: "https://files.pythonhosted.org/packages/ce/d7/c5892390196d05c5ce4f4f78bd39b5d7af9b984ae08776e9f6abf91637ff/azure-containerregistry-1.1.0.zip" 
              - name: azure-cosmos
                service: cosmos
                checkout:
                - package: azure-cosmos
                  download_uri: https://files.pythonhosted.org/packages/90/dc/d962600643262152e5b8ab166a5327881a9ac91d6b7e1049ccbec7a2b5d7/azure-cosmos-4.3.1.zip
              - name: azure-data-tables
                service: tables
                checkout:
                - package: azure-data-tables
                  download_uri: https://files.pythonhosted.org/packages/91/03/606dc3a49f054e3055b7eaf581ea988b76376b66874a2a59ccf1e988c5ee/azure-data-tables-12.4.2.zip
              - name: azure-developer-loadtesting
                service: loadtesting
                checkout:
                - package: azure-developer-loadtesting
                  download_uri: https://files.pythonhosted.org/packages/15/8e/610c3e58f373f305636d322480c49d0f340025770df2bd4b3610d28d3a8a/azure-developer-loadtesting-1.0.0.zip
  # # - ${{if and(ne(variables['Build.Reason'], 'PullRequest'), eq(variables['System.TeamProject'], 'internal'))}}:
  # #   - template: archetype-conda-release.yml
  # #     parameters:
  # #       DependsOn: Build
  # #       CondaArtifacts: $(CondaArtifacts)