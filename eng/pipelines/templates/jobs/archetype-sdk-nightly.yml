parameters:
  ServiceDirectory: ''
  BeforePublishSteps: []
  TestMarkArgument: ''
  BuildTargetingString: 'azure-*'

jobs:
  - job: 'Build'
    variables:
    - template: ../variables/globals.yml

    pool:
      vmImage: 'ubuntu-16.04'

    steps:
    - template: ../steps/build-artifacts.yml
      parameters: 
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        BuildTargetingString: ${{ parameters.BuildTargetingString }}
        BeforePublishSteps: ${{ parameters.BeforePublishSteps }}
          
  - job: 'Analyze'
    variables:
    - template: ../variables/globals.yml

    dependsOn:
      - 'Build'

    pool:
      vmImage: 'ubuntu-16.04'

      steps:
      - template: ../steps/analyze.yml

  - job: 'Generic_Tests'
    variables:
    - template: ../variables/globals.yml

    dependsOn:
       - 'Build'

    timeoutInMinutes: 180

    strategy:
      matrix:
        Linux_Python27:
          OSName: 'Linux'
          OSVmImage: 'ubuntu-16.04'
          PythonVersion: '2.7'
        Linux_Python35:
          OSName: 'Linux'
          OSVmImage: 'ubuntu-16.04'
          PythonVersion: '3.5'
        Linux_Python36:
          OSName: 'Linux'
          OSVmImage: 'ubuntu-16.04'
          PythonVersion: '3.6'
        Linux_Python37:
          OSName: 'Linux'
          OSVmImage: 'ubuntu-16.04'
          PythonVersion: '3.7'
        Windows_Python35:
          OSName: 'Windows'
          OSVmImage: 'vs2017-win2016'
          PythonVersion: '3.5'
        MacOS_Python27:
          OSName: 'MacOS'
          OSVmImage: 'macOS-10.13'
          PythonVersion: '2.7'

    pool:
      vmImage: '$(OSVmImage)'

    steps:
    - template: ../steps/build-test.yml
      parameters: 
        ServiceDirectory: ${{ parameters.ServiceDirectory }}
        TestMarkArgument: ${{ parameters.TestMarkArgument }}
        OSName: $(OSName)
        PythonVersion: $(PythonVersion)
        BuildTargetingString: ${{ parameters.BuildTargetingString }}
        AdditionalTestArgs: '--wheel_dir="$(Build.ArtifactStagingDirectory)" --tparallel'
        BeforeTestSteps: 
            - task: DownloadPipelineArtifact@0
              inputs:
                artifactName: 'artifacts' 
                targetPath: $(Build.ArtifactStagingDirectory)
        ToxTestEnv: "whl,sdist"  
        AdditionalTestSteps:
            - task: PythonScript@0
              displayName: 'Install Packages (Global)'
              inputs:
                scriptPath: 'scripts/devops_tasks/setup_execute_tests.py'
                arguments: '"${{ parameters.BuildTargetingString }}" --runtype=setup --disablecov --service="${{ parameters.ServiceDirectory }}"'
              env: ${{ parameters.EnvVars }}
              condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))

            - task: PythonScript@0
              displayName: 'Run Tests (Global)'
              inputs:
                scriptPath: 'scripts/devops_tasks/setup_execute_tests.py'
                arguments: >-
                  "${{ parameters.BuildTargetingString }}" 
                  --runtype=execute 
                  --disablecov 
                  --mark_arg="${{ parameters.TestMarkArgument }}" 
                  --service="${{ parameters.ServiceDirectory }}"
              env: ${{ parameters.EnvVars }}
              condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))
    - template: ../steps/publish-coverage.yml

  # Run PyPy tests without coverage
  - job: 'Test_PyPy'

    variables:
    - template: ../variables/globals.yml
    - name: OSName
      value: 'Linux'
    - name: PythonVersion
      value: 'pypy3'
    - name: OSVmImage
      value: ubuntu-16.04

    dependsOn:
      - 'Build'

    pool:
      vmImage: $(OSVmImage)

    steps:
      - template: ../steps/build-test.yml
        parameters:
          AdditionalTestArgs: '--disablecov --wheel_dir="$(Build.ArtifactStagingDirectory)" --tparallel'
          ServiceDirectory: ${{ parameters.ServiceDirectory }}
          TestMarkArgument: ${{ parameters.TestMarkArgument }}
          OSName: $(OSName)
          PythonVersion: $(PythonVersion)
          BuildTargetingString: ${{ parameters.BuildTargetingString }}
          BeforeTestSteps: 
            - task: DownloadPipelineArtifact@0
              inputs:
                artifactName: 'artifacts' 
                targetPath: $(Build.ArtifactStagingDirectory)
          ToxTestEnv: "whl,sdist"
          AdditionalTestSteps:
            - task: PythonScript@0
              displayName: 'Install Packages (Global)'
              inputs:
                scriptPath: 'scripts/devops_tasks/setup_execute_tests.py'
                arguments: '"${{ parameters.BuildTargetingString }}" --runtype=setup --disablecov --service="${{ parameters.ServiceDirectory }}"'
              env: ${{ parameters.EnvVars }}
              condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))

            - task: PythonScript@0
              displayName: 'Run Tests (Global)'
              inputs:
                scriptPath: 'scripts/devops_tasks/setup_execute_tests.py'
                arguments: >-
                  "${{ parameters.BuildTargetingString }}" 
                  --runtype=execute 
                  --disablecov 
                  --mark_arg="${{ parameters.TestMarkArgument }}" 
                  --service="${{ parameters.ServiceDirectory }}"
              env: ${{ parameters.EnvVars }}
              condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))