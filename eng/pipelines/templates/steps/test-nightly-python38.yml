parameters:
  AdditionalTestArgs: ''
  TestMarkArgument: ''
  EnvVars: {}
  ServiceDirectory: ''
  PythonVersion: ''
  OSName: ''
  BeforeTestSteps: []
  CoverageArg: ''
  BuildTargetingString: 'azure-*'
  ToxTestEnv: ""
  RunCoverage: ne(variables['CoverageArg'], '--disablecov')

steps:
  - pwsh: |
      gci -r $(Build.ArtifactStagingDirectory)

  - template: eng/pipelines/templates/scripts/verify-agent-os.yml@azure-sdk-tools
    parameters:
      OSName: ${{ parameters.OSName }}

  - script: |
      mkdir ~/python3.8
      cd ~/python3.8
      wget https://www.python.org/ftp/python/3.8.0/Python-3.8.0.tar.xz
      ls
      tar -xf Python-3.8.0.tar.xz
      ls
      find ~/python3.8 -type d | xargs chmod 0755
      cd python-3.8.0
      ../configure --enable-optimizations --enable-shared --prefix=$HOME
      make install
      export PATH=~/python3.8/python-3.8.0/:$PATH
      which python3.8
      apt-get install python3.8-dev
      apt-get install python3.8-distutils          
      wget https://bootstrap.pypa.io/get-pip.py -o get-pip.py | python3.8 - --user
      export PATH=~/.local/bin:$PATH  
      which pip      
      python3.8 -m pip install tox tox-monorepo packaging
      cd $(Build.SourcesDirectory)
      python3.8 -m pip install twine codecov beautifulsoup4
    displayName: 'Prep Environment Using Python 3.8'

  - ${{ parameters.BeforeTestSteps }}

  - task: PythonScript@0
    inputs:
      scriptPath: scripts/devops_tasks/setup_execute_tests.py
      pythonInterpreter: python3.8
      arguments: >-
        "${{ parameters.BuildTargetingString }}"
        --mark_arg="${{ parameters.TestMarkArgument }}" 
        --service="${{ parameters.ServiceDirectory }}"
        ${{ parameters.AdditionalTestArgs }}
        ${{ parameters.CoverageArg }}
        --toxenv="${{ parameters.ToxTestEnv }}"
    displayName: 'Run Tests'
    env: ${{ parameters.EnvVars }}

  - task: PublishTestResults@2
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: '**/*test*.xml'
      testRunTitle: '${{ parameters.OSName }} Python ${{ parameters.PythonVersion }}'
  
  - task: PythonScript@0
    displayName: 'Install Packages (Global)'
    inputs:
      pythonInterpreter: python3.8
      scriptPath: scripts/devops_tasks/setup_execute_tests.py
      arguments: '"${{ parameters.BuildTargetingString }}" --runtype=setup --disablecov --service="${{ parameters.ServiceDirectory }}"'
    env: ${{ parameters.EnvVars }}
    condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))

  - task: PythonScript@0
    displayName: 'Run Tests (Global)'
    inputs:
      pythonInterpreter: python3.8
      script: scripts/devops_tasks/setup_execute_tests.py
      arguments: >-
        "${{ parameters.BuildTargetingString }}"
        --runtype=execute 
        --disablecov 
        --mark_arg="${{ parameters.TestMarkArgument }}" 
        --service="${{ parameters.ServiceDirectory }}"
    env: ${{ parameters.EnvVars }}
    condition: and(succeededOrFailed(), ne(variables['Build.Reason'], 'PullRequest'))

  - template: publish-coverage.yml
    parameters: 
      RunCoverage: ${{ parameters.RunCoverage }}