parameters:
  - name: CondaArtifacts
    type: object
    default: []

steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python $(PythonVersion)'
    inputs:
      versionSpec: $(PythonVersion)

  - pwsh: |
      pip install tools/azure-sdk-tools[build]
      pip install disutils
    displayName: Install build script requirements

  - pwsh: |
      $argument = @'${{ replace(convertToJson(parameters.CondaArtifacts), '"', '\"') }}'@

      sdk_build_conda -c "$argument" -w "$(Build.SourcesDirectory)/conda/conda-recipes"
    displayName: Assemble Conda Packages
  
  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/assembled'
      ArtifactName: 'distributions'

  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/assembled'
      ArtifactName: 'conda'

  - ${{if eq(variables['System.TeamProject'], 'internal') }}:
    - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
      displayName: 'Upload Conda SBOM'
      condition: succeededOrFailed()
      inputs:
        BuildDropPath: '$(Build.ArtifactStagingDirectory)/manifest'

    - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
      parameters:
        ArtifactPath: '$(Build.ArtifactStagingDirectory)/manifest/_manifest'
        ArtifactName: 'manifest'
