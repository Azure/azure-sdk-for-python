parameters:
  - name: CondaArtifacts
    type: object
    default: []

steps:
  - task: UsePythonVersion@0
    displayName: 'Use Python $(PythonVersion)'
    inputs:
      versionSpec: $(PythonVersion)

  - pwsh: |
      pip install disutils
    displayName: Install build script requirements

  - task: PythonScript@0
    displayName: 'Invoke build script against argument'
    inputs:
      scriptPath: 'scripts/devops_tasks/build_conda_artifacts.py'
      arguments: |
        -c "${{ replace(convertToJson(parameters.CondaArtifacts), '"', '\"') }}"
        -w "$(Build.SourcesDirectory)/conda/conda-recipes"
  
  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/assembled'
      ArtifactName: 'distributions'

  - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
    parameters:
      ArtifactPath: '$(Build.SourcesDirectory)/conda/assembled'
      ArtifactName: 'conda'

  - ${{if eq(variables['System.TeamProject'], 'internal') }}:
    - task: AzureArtifacts.manifest-generator-task.manifest-generator-task.ManifestGeneratorTask@0
      displayName: 'Upload Conda SBOM'
      condition: succeededOrFailed()
      inputs:
        BuildDropPath: '$(Build.ArtifactStagingDirectory)/manifest'

    - template: /eng/common/pipelines/templates/steps/publish-artifact.yml
      parameters:
        ArtifactPath: '$(Build.ArtifactStagingDirectory)/manifest/_manifest'
        ArtifactName: 'manifest'
