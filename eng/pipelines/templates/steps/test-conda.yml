parameters:
  - name: TestPipeline
    type: boolean
    default: false
  - name: ServiceDirectory
    type: string
    default: ''
  - name: CondaArtifacts
    type: object
    default: []
  - name: TestMarkArgument
    type: string
    default: ''
  - name: PythonVersion
    type: string
    default: ''
  - name: OSVmImage
    type: string
    default: ''

steps:
  - task: DownloadPipelineArtifact@2
    inputs:
      artifactName: 'conda'
      targetPath: $(Build.ArtifactStagingDirectory)

  - template: /eng/common/pipelines/templates/steps/set-test-pipeline-version.yml
    parameters:
      PackageName: "azure-template"
      ServiceDirectory: "template"
      TestPipeline: ${{ parameters.TestPipeline }}

  - task: UsePythonVersion@0
    displayName: 'Use Python $(PythonVersion)'
    inputs:
      versionSpec: $(PythonVersion)

  - ${{ each artifact in parameters.CondaArtifacts }}:
    # there may be multiple CondaArtifacts. Be certain $(conda.build) is clean just in case!
    - pwsh:
        Write-Host "Clean up Conda Build Directory $(conda.build)"
        Remove-Item $(conda.build)/* -Recurse -Force
      displayName: 'Clean Up Before Building ${{ artifact.name }}'

    - ${{ each checkout in artifact.checkout }}:
      - template: /eng/pipelines/templates/steps/get-tagged-code.yml
        parameters:
          DestinationDirectory: $(conda.build)/${{checkout.package}}
          Package: ${{checkout.package}}
          CheckoutPath: ${{checkout.checkout_path}}
          Version: ${{checkout.version}}

    - task: PythonScript@0
      displayName: 'Build Source Distribution for ${{ artifact.name }}'
      inputs:
        scriptPath: 'scripts/devops_tasks/build_conda_artifacts.py'
        arguments: >-
          -d "$(conda.output)"
          -b "$(conda.build)"
          -m "$(Build.SourcesDirectory)/sdk/${{ parameters.ServiceDirectory }}/${{ artifact.meta_source }}"
          -r "${{ artifact.common_root }}"
          -n "${{ artifact.name }}"
          -s "${{ parameters.ServiceDirectory }}"
          -e "$(Build.SourcesDirectory)/eng/conda_env.yml"
          -c "$(Build.SourcesDirectory)/sdk/${{ parameters.ServiceDirectory }}/ci.yml"

    - bash: |
        echo "##vso[task.prependpath]$CONDA/bin"
      displayName: 'Prepend PATH with Conda and INIT'

    - bash: |
        conda index $(Build.ArtifactStagingDirectory)/conda/${{ artifact.name }}
        conda env create --name ${{ artifact.name }} --file $(Build.SourcesDirectory)/eng/conda_env.yml
      displayName: 'Prepare Conda Environment for Testing ${{ artifact.name }}, Index the Target Artifact'

    - bash: |
        source activate ${{ artifact.name }}
        pip install -r eng/ci_tools.txt
        conda install {{ artifact.name }} -c $(Build.ArtifactStagingDirectory)/conda/${{ artifact.name }}
      displayName: 'Activate Conda Environment and Install General Dependencies ${{ artifact.name }}'
      workingDirectory: $(Build.SourcesDirectory)/sdk/${{ parameters.ServiceDirectory }}

    - ${{ each checkout in artifact.checkout }}:
      - bash: |
          source activate ${{ artifact.name }}
          pip install -r dev_requirements.txt
          pytest .
        displayName: 'Run tests for '
        workingDirectory: $(Build.SourcesDirectory)/sdk/${{ checkout.path }}/${{ checkout.package }}

    - bash: |
        source activate ${{ artifact.name }}
      displayName: 'Activate Conda Environment and Build ${{ artifact.name }}'
      workingDirectory: $(Build.SourcesDirectory)

