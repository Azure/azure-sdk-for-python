parameters:
  - name: ServiceDirectory
    type: string
    default: ''
  - name: Artifacts
    type: object
    default: []

# The variable TargetingString is set by template `eng/pipelines/templates/steps/targeting-string-resolve.yml`. This template is invoked from yml files:
#     eng/pipelines/templates/jobs/ci.tests.yml
#     eng/pipelines/templates/jobs/ci.yml
#     eng/pipelines/templates/jobs/live.test.yml

# Please use `$(TargetingString)` to refer to the python packages glob string. This was previously `${{ parameters.BuildTargetingString }}`.
steps:
  - bash: |
      python -m venv $(Agent.BuildDirectory)/venv
      source $(Agent.BuildDirectory)/venv/bin/activate
      mkdir -p $(Agent.BuildDirectory)/workdir
      
      python -m pip install packaging==20.4 msrest aiohttp
      python -m pip install -r $(Build.SourcesDirectory)/eng/apiview_reqs.txt --index-url="https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-python/pypi/simple/"
      python -m pip freeze
    displayName: Install API Stub Generator
    condition: and(succeededOrFailed(), ne(variables['Skip.ApiStubGen'],'true'))

  - ${{ each artifact in parameters.Artifacts }}:
    - bash: |
        source $(Agent.BuildDirectory)/venv/bin/activate
        apistubgen --pkg-path $(Build.SourcesDirectory)/sdk/${{ parameters.ServiceDirectory}}/${{ artifact.name }}/
      displayName: Run API Stub Generator against ${{ artifact.name }}
      condition: and(succeededOrFailed(), ne(variables['Skip.ApiStubGen'],'true'))