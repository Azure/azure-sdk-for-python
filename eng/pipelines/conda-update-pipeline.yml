trigger: none
pr: none

parameters:
  - name: releaseDate
    displayName: Release Date (MM.DD)
    type: string
    default: 'auto'
    values:
      - auto
      - 03.01
      - 06.01
      - 09.01
      - 12.01
  - name: dryRun
    displayName: Dry Run (skip PR submission)
    type: boolean
    default: false

# Scheduled to run a week before each quarterly release
schedules:
  - cron: "0 0 24 11 *"  
    displayName: Pre-December Quarterly Release
    branches:
      include:
        - main
    always: true
  - cron: "0 0 22 2 *" 
    displayName: Pre-March Quarterly Release
    branches:
      include:
        - main
    always: true
  - cron: "0 0 25 5 *" 
    displayName: Pre-June Quarterly Release
    branches:
      include:
        - main
    always: true
  - cron: "0 0 25 8 *" 
    displayName: Pre-September Quarterly Release
    branches:
      include:
        - main
    always: true

extends:
  template: /eng/pipelines/templates/stages/1es-redirect.yml
  parameters:
    stages:
      - stage: UpdateCondaFiles
        displayName: Update Conda Files

        jobs:
          - job: UpdateCondaFilesJob
            timeoutInMinutes: 90
            displayName: Update Conda Files and Submit PR
            variables:
              - template: /eng/pipelines/templates/variables/globals.yml
              - name: ReleaseDate
                ${{ if eq(parameters.releaseDate, 'auto') }}:
                  ${{ if contains(variables['Build.CronSchedule.DisplayName'], 'December') }}:
                    value: '12.01'
                  ${{ elseif contains(variables['Build.CronSchedule.DisplayName'], 'March') }}:
                    value: '03.01'
                  ${{ elseif contains(variables['Build.CronSchedule.DisplayName'], 'June') }}:
                    value: '06.01'
                  ${{ elseif contains(variables['Build.CronSchedule.DisplayName'], 'September') }}:
                    value: '09.01'
                  ${{ else }}:
                    value: 'Unknown'
                ${{ else }}:
                  value: ${{ parameters.releaseDate }}

            pool:
              name: azsdk-pool
              image: ubuntu-24.04
              os: linux

            steps:
              - checkout: self
                persistCredentials: true

              - task: UsePythonVersion@0
                displayName: 'Use Python 3.11'
                inputs:
                  versionSpec: '3.11'

              - script: |
                  python -m pip install --upgrade pip
                  python -m pip install "eng/tools/azure-sdk-tools[build]"
                  python -m pip install python-dateutil
                displayName: 'Prep Environment'

              - script: |
                  if [ "$(ReleaseDate)" != "Unknown" ]; then
                    python conda/update_conda_files.py --release-date "$(ReleaseDate)"
                  else
                    python conda/update_conda_files.py
                  fi
                displayName: 'Update Conda Files'

              - ${{ if eq(parameters.dryRun, false) }}:
                - template: /eng/common/pipelines/templates/steps/create-pull-request.yml
                  parameters:
                    PRBranchName: conda-update-$(Build.BuildId)
                    CommitMsg: 'Update conda files for $(CondaReleaseVersion) release'
                    PRTitle: 'Conda Release $(CondaReleaseVersion) generated by $(Build.BuildId)'
                    PRBody: |
                      This PR was automatically generated to update Conda files for a new release.

                      - Updates outdated package versions in conda-sdk-client.yml
                      - Adds new packages to conda-sdk-client.yml
                      - Adds/updates yamls and changelogs 
                      
                      ## Next Steps 
                      - [ ] For new data plane packages, submit this form to create a private dummy library placeholder in Conda before uploading a release: https://forms.office.com/Pages/ResponsePage.aspx?id=v4j5cvGGr0GRqy180BHbR180k2XpSUFBtXHTh8-jMUlUNlA1MFpZOVhZME1aNU1EU1Y3SjZRU0JNRC4u
                      - [ ] After this PR is merged and succeeds the Conda build, approve the pipeline to upload the releases to Conda
                      - [ ] After upload, delete the dummy libraries and make the new packages publicly available in Conda.
                      - [ ] Create an AKA link for new release logs here: http://aka.ms/
                    BaseBranchName: main
