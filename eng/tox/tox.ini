
# This tox file is intended for use with any generic development feed. The only requirement is that the development feed
# contain azure* prefixed packages. It does this by assuming that `PIP_INDEX_URL` environment variable is set to target the dev feed
# specifically. Notice that in the [testenv] config, we explicitly set PIP_EXTRA_INDEX_URL to pypi.

# In all cases, whenever we install an azure-* package from a requirement (read: not a specific file), the only source will be from the dev feed.
# once we've downloaded these dependencies, only then do we install other packages from pypi.
[tox]
# note that this envlist is the default set of environments that will run if a target environment is not selected.
envlist = whl,sdist


[tools]
deps =
  -r {repository_root}/eng/test_tools.txt


[coverage:paths]
source =
    azure
    **/azure
    microsoft
    **/microsoft


[base]
deps =
  -rdev_requirements.txt
  {[tools]deps}


[dependencytools]
deps =
    -r {repository_root}/eng/dependency_tools.txt


[packaging]
pkgs =
    wheel==0.37.0
    packaging==20.4
    urllib3==1.26.12
    tomli==2.0.1


[testenv]
ignore_args=--ignore=.tox --ignore=build --ignore=.eggs
default_pytest_params = --junitxml={tox_root}/test-junit-{envname}.xml --verbose --durations=10 --ignore=azure {[testenv]ignore_args}
parallel_show_output =True
skip_install = true
skipsdist = true
usedevelop = false
platform = linux: linux
           macos: darwin
           windows: win32
passenv = *
download=true
requires=
  {[packaging]pkgs}
setenv =
  SPHINX_APIDOC_OPTIONS=members,undoc-members,inherited-members
  PIP_EXTRA_INDEX_URL=https://pypi.python.org/simple
  PROXY_URL=http://localhost:5000
  VIRTUALENV_WHEEL=0.37.0
  VIRTUALENV_PIP=20.3.3
  VIRTUALENV_SETUPTOOLS=67.6.0
deps = {[base]deps}
changedir = {tox_root}
install_command = python -m pip install {opts} {packages} --cache-dir {tox_root}/../.tox_pip_cache_{envname} --ignore-installed
commands =
    python -m pip --version
    python {repository_root}/eng/tox/create_package_and_install.py -d {envtmpdir} -p {tox_root} -w {envtmpdir}
    python -m pip freeze
    pytest \
      {[testenv]default_pytest_params} \
      {posargs} \
      {tox_root}


[testenv:pylint]
skipsdist = true
skip_install = true
usedevelop = false
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5002
deps =
  {[base]deps}
commands =
    python -m pip install azure-pylint-guidelines-checker==0.0.5 --index-url="https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-python/pypi/simple/"
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/run_pylint.py -t {tox_root}

[testenv:next-pylint]
skipsdist = true
skip_install = true
usedevelop = false
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5002
deps =
  {[base]deps}
commands =
    python -m pip install pylint==2.15.8
    python -m pip install azure-pylint-guidelines-checker==0.0.8 --index-url="https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-python/pypi/simple/"
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/run_pylint.py -t {tox_root} --next=True

[testenv:mypy]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5003
deps =
  {[base]deps}
  mypy==1.0.0
  types-chardet==4.0.3
  types-requests==2.27.9
  types-six==1.16.10
  types-redis==4.3.21.2
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/run_mypy.py -t {tox_root}

[testenv:next-mypy]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5020
deps =
  {[base]deps}
  mypy
  types-chardet
  types-requests
  types-six
  types-redis
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/run_mypy.py -t {tox_root} --next=True


[testenv:pyright]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5018
deps =
  {[base]deps}
  pyright==1.1.287
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/create_dependencies_and_install.py -p {tox_root}
    python {repository_root}/eng/tox/run_pyright.py -t {tox_root}


[testenv:next-pyright]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5021
deps =
  {[base]deps}
  pyright
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/create_dependencies_and_install.py \
      -p {tox_root}
    python {repository_root}/eng/tox/run_pyright.py -t {tox_root} --next=True


[testenv:verifytypes]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5019
deps =
  {[base]deps}
  pyright==1.1.287
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/eng/tox/create_dependencies_and_install.py \
      -p {tox_root}
    python {repository_root}/eng/tox/run_verifytypes.py -t {tox_root}


[testenv:whl_no_aio]
skipsdist = true
skip_install = true
changedir = {tox_root}
deps =
  {[base]deps}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5004
commands =
    - python -m pip uninstall aiohttp --yes
    python {repository_root}/eng/tox/create_package_and_install.py -d {envtmpdir} -p {tox_root} -w {envtmpdir}
    python {repository_root}/eng/tox/try_import.py aiohttp -p {tox_root}
    python -m pip freeze
    pytest \
      {[testenv]default_pytest_params} \
      --ignore-glob='*async*.py' \
      {posargs} \
      {tox_root}


[testenv:sdist]
skipsdist = true
skip_install = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5005
deps =
  {[base]deps}
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {envtmpdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python -m pip freeze
    pytest \
      {posargs} \
      --no-cov \
      {[testenv]ignore_args} \
      {tox_root}


[testenv:develop]
skipsdist = false
skip_install = false
usedevelop = true
changedir = {tox_root}
deps =
  {[base]deps}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5006
commands =
    pytest \
      {posargs} \
      --ignore=.tox \
      {tox_root}


[testenv:sphinx]
skipsdist = true
skip_install = true
changedir = {tox_root}
passenv = *
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5007
deps =
  {[base]deps}
  sphinx==3.5.4
  sphinx_rtd_theme==1.0.0
  recommonmark==0.6.0
  mistune<2.0.0
  m2r==0.2.1
commands =
  python {repository_root}/eng/tox/create_package_and_install.py \
    -d {distdir} \
    -p {tox_root} \
    -w {envtmpdir} \
    --package-type sdist
  python {repository_root}/eng/tox/prep_sphinx_env.py -d {distdir} -t {tox_root}
  python {repository_root}/eng/tox/run_sphinx_apidoc.py \
    -w {distdir} \
    -r {tox_root}

  python {repository_root}/eng/tox/run_sphinx_build.py \
    -w {distdir}/unzipped/docgen \
    -o {distdir}/site \
    -r {tox_root}


[testenv:depends]
platform = linux: linux
           macos: darwin
           windows: win32
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5008
deps =
  {[packaging]pkgs}
  cryptography<4
commands =
    python -m pip install {repository_root}/tools/azure-sdk-tools --no-deps
    python {repository_root}/eng/tox/sanitize_setup.py -t {tox_root}
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {envtmpdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --force-create true
    python -m pip freeze
    python {repository_root}/eng/tox/import_all.py -t {tox_root}


[testenv:verifywhl]
skipsdist = true
skip_install = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5009
deps =
    {[packaging]pkgs}
commands =
    python -m pip install {repository_root}/tools/azure-sdk-tools --no-deps
    python {repository_root}/eng/tox/create_package_and_install.py -d {envtmpdir} -p {tox_root} --skip-install True
    python {repository_root}/eng/tox/verify_whl.py -d {envtmpdir} -t {tox_root}


[testenv:verifysdist]
skipsdist = true
skip_install = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5010
deps =
    {[packaging]pkgs}
commands =
    python -m pip install {repository_root}/tools/azure-sdk-tools --no-deps
    python {tox_root}/setup.py --q sdist --format zip -d {envtmpdir}
    python {repository_root}/eng/tox/verify_sdist.py -d {envtmpdir} -t {tox_root}


[testenv:devtest]
deps = {[base]deps}
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5011
commands =
    python {repository_root}/eng/tox/create_package_and_install.py -d {envtmpdir} -p {tox_root}
    python {repository_root}/eng/tox/install_dev_build_dependency.py -t {tox_root}
    pytest \
      {[testenv]default_pytest_params} \
      --ignore=.tox \
      {posargs} \
      {tox_root}


[deptestcommands]
commands =
    python {repository_root}/eng/tox/install_depend_packages.py -t {tox_root} -d {env:DEPENDENCY_TYPE:} -w {envtmpdir}
    python {repository_root}/eng/tox/create_package_and_install.py -d {envtmpdir} -p {tox_root} -w {envtmpdir} --pre-download-disabled
    python -m pip freeze
    python {repository_root}/eng/tox/verify_installed_packages.py --packages-file {envtmpdir}/packages.txt
    pytest {[testenv]default_pytest_params} {posargs} --no-cov {tox_root}


[testenv:latestdependency]
deps =
  {[dependencytools]deps}
  {[tools]deps}
changedir =
  {tox_root}
passenv = *
setenv =
  {[testenv]setenv}
  DEPENDENCY_TYPE=Latest
  PROXY_URL=http://localhost:5012
commands =
    {[deptestcommands]commands}


[testenv:mindependency]
deps =
  azure-mgmt-keyvault<7.0.0
  azure-mgmt-resource<15.0.0
  azure-mgmt-storage<15.0.0
  {[dependencytools]deps}
  {[tools]deps}
changedir = {tox_root}
passenv = *
setenv =
  {[testenv]setenv}
  DEPENDENCY_TYPE=Minimum
  PROXY_URL=http://localhost:5013
commands =
    {[deptestcommands]commands}


[testenv:apistub]
skipsdist = true
skip_install = true
usedevelop = false
changedir = {envtmpdir}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5014
deps =
  {[base]deps}
commands =
    # install API stub generator
    python -m pip install -r {repository_root}/eng/apiview_reqs.txt --index-url="https://pkgs.dev.azure.com/azure-sdk/public/_packaging/azure-sdk-for-python/pypi/simple/"
    python -m pip freeze
    python {repository_root}/eng/tox/run_apistubgen.py -t {tox_root} -w {envtmpdir} {posargs}


[testenv:bandit]
skipsdist = true
skip_install = true
usedevelop = false
changedir = {envtmpdir}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5015
deps =
  {[base]deps}
  importlib-metadata<5.0
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {envtmpdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python -m pip freeze
    python {repository_root}/eng/tox/run_bandit.py -t {tox_root}


[testenv:samples]
skipsdist = false
skip_install = false
usedevelop = false
changedir = {envtmpdir}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5016
deps =
  {[base]deps}
  subprocess32; python_version < '3.5'
commands =
    python -m pip freeze
    python {repository_root}/scripts/devops_tasks/test_run_samples.py -t {tox_root}


[testenv:breaking]
skipsdist = true
skip_install = true
usedevelop = true
changedir = {tox_root}
setenv =
  {[testenv]setenv}
  PROXY_URL=http://localhost:5017
deps =
  {[base]deps}
  jsondiff==1.2.0
  -e {repository_root}/scripts/breaking_changes_checker
commands =
    python {repository_root}/eng/tox/create_package_and_install.py \
      -d {distdir} \
      -p {tox_root} \
      -w {envtmpdir} \
      --package-type sdist
    python {repository_root}/scripts/breaking_changes_checker/detect_breaking_changes.py -t {tox_root}
