jobs:
- job: Special_Python_Distro_Tests
  dependsOn:
  - 'Publish'
  pool:
    vmImage: 'ubuntu-16.04'
  steps:
  - script: |
     mkdir local_install
     cd local_install
     
     wget https://s3.amazonaws.com/travis-python-archives/binaries/ubuntu/14.04/x86_64/pypy3.5-5.8.0.tar.bz2
     tar -xjf pypy3.5-5.8.0.tar.bz2
     
    displayName: 'Download PyPy Python'
    continueOnError: false

  - script: '$(Build.SourcesDirectory)/local_install/opt/python/pypy3.5-5.8.0/bin/pypy3 scripts/dev_setup.py'
    displayName: 'Setup Tests'
    continueOnError: true

  - powershell: |
     $inputFilterSet="$(build_targeting_string)"
     
     if ($inputFilterSet -eq "")
     {
         $inputFilterSet = "azure-*"
     }
     
     foreach($inputFilter in "$inputFilterSet".split(","))
     {
         $foldersToIterate = Get-ChildItem -Name -Recurse -Filter "$inputFilter"
         $foldersToIterate = $foldersToIterate.foreach({"$(Build.SourcesDirectory)/$_/"})
         $folderCombination = $foldersToIterate -join " "
     
         $(Build.SourcesDirectory)/local_install/opt/python/pypy3.5-5.8.0/bin/pypy3 -m pytest $folderCombination --ignore=local_install 
     }
    displayName: 'Run Test Subset'
    continueOnError: true

  - script: |
     $(Build.SourcesDirectory)/local_install/opt/python/pypy3.5-5.8.0/bin/pypy3 ./setup.py check -r -s
    displayName: 'Check Setup.py Files'
    continueOnError: true