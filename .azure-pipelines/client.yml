trigger:
- master

jobs:
- job: 'Publish'

  pool:
    vmImage: 'vs2017-win2016'  

  steps:
  - script: |
     python -m venv .\
     
     pip install git+https://github.com/lmazuel/swagger-to-sdk
     pip install -e "git+https://github.com/Azure/azure-sdk-for-python#subdirectory=azure-sdk-tools&egg=azure-sdk-tools"

    displayName: 'Prep Environment, Install Packages'

  - bash: |
     IN=$(build_targeting_string)
     
     while IFS=',' read -ra FILTERS; do
       for i in "${FILTERS[@]}"; do
       folderNames=$(ls -d $i)
         for folderName in $folderNames; do
           echo python ./build_package.py --dest "$(Build.ArtifactStagingDirectory)" "$folderName"
         done
       done
     done <<< "$IN"
    displayName: 'Generate Packages'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'

- template: client.test.yml
  parameters:
    name: Linux
    vmImage: 'ubuntu-16.04'

- template: client.test.yml
  parameters:
    name: macOS
    vmImage: 'macOS-10.13'

- template: client.test.yml
  parameters:
    name: Windows
    vmImage: 'vs2017-win2016'