# pylint: disable=line-too-long,useless-suppression
# coding=utf-8
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# Code generated by Microsoft (R) Python Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is regenerated.
# --------------------------------------------------------------------------

import asyncio
from calendar import c
import os
from datetime import datetime
import uuid

from azure.ai.contentunderstanding.aio import ContentUnderstandingClient
from azure.ai.contentunderstanding.models import (
    ContentClassifier,
    ClassifierCategoryDefinition,
    DocumentContent,
)
from typing import Optional, Dict

from sample_helper import (
    save_json_to_file,
)
from azure.core.credentials import AzureKeyCredential
from azure.identity.aio import DefaultAzureCredential

from dotenv import load_dotenv

load_dotenv()

"""
Prerequisites:
    pip install azure-ai-contentunderstanding python-dotenv
    az login  # Used for DefaultAzureCredential(). Alternatively, set the AZURE_CONTENT_UNDERSTANDING_KEY environment variable

Environment variables:
    AZURE_CONTENT_UNDERSTANDING_ENDPOINT   (required)
    AZURE_CONTENT_UNDERSTANDING_KEY        (optional - DefaultAzureCredential() will be used if not set)
    These variables can be set in a .env file in the samples directory for repeated use. Please see env.sample for an example.

Run:
    python content_classifiers_classify.py
"""


def new_simple_classifier_schema(
    classifier_id: str,
    description: Optional[str] = None,
    tags: Optional[Dict[str, str]] = None,
) -> ContentClassifier:
    """Create a simple ContentClassifier object with default configuration.

    Args:
        classifier_id: The classifier ID
        description: Optional description for the classifier
        tags: Optional tags for the classifier

    Returns:
        ContentClassifier: A configured ContentClassifier object
    """
    if description is None:
        description = f"test classifier: {classifier_id}"
    if tags is None:
        tags = {"test_type": "simple"}

    return ContentClassifier(
        categories={
            "Loan application": ClassifierCategoryDefinition(
                description="Documents submitted by individuals or businesses to request funding, typically including personal or business details, financial history, loan amount, purpose, and supporting documentation."
            ),
            "Invoice": ClassifierCategoryDefinition(
                description="Billing documents issued by sellers or service providers to request payment for goods or services, detailing items, prices, taxes, totals, and payment terms."
            ),
            "Bank_Statement": ClassifierCategoryDefinition(
                description="Official statements issued by banks that summarize account activity over a period, including deposits, withdrawals, fees, and balances."
            ),
        },
        split_mode="auto",
        description=description,
        tags=tags,
    )


async def main():
    """
    Classify document using the new begin_classify URL and data parameter overrides.

    High-level steps:
    1. Create a custom classifier
    2. Classify a document from a remote URL using the new URL parameter
    3. Classify a document from binary data using the new data parameter
    4. Save the classification results to files
    5. Clean up the created classifier
    """
    endpoint = os.getenv("AZURE_CONTENT_UNDERSTANDING_ENDPOINT") or ""
    # Return AzureKeyCredential if AZURE_CONTENT_UNDERSTANDING_KEY is set, otherwise DefaultAzureCredential
    key = os.getenv("AZURE_CONTENT_UNDERSTANDING_KEY")
    credential = AzureKeyCredential(key) if key else DefaultAzureCredential()

    async with ContentUnderstandingClient(endpoint=endpoint, credential=credential) as client:
        classifier_id = f"sdk-sample-clf-{datetime.now().strftime('%Y%m%d')}-{datetime.now().strftime('%H%M%S')}-{uuid.uuid4().hex[:8]}"

        # Create a custom classifier using object model
        print(f"üîß Creating custom classifier '{classifier_id}'...")

        classifier_schema = new_simple_classifier_schema(
            classifier_id=classifier_id,
            description=f"Custom classifier for URL and data classification demo: {classifier_id}",
            tags={"demo_type": "url_and_data_classification"},
        )

        # Start the classifier creation operation
        poller = await client.content_classifiers.begin_create_or_replace(
            classifier_id=classifier_id,
            resource=classifier_schema,
        )

        # Wait for the classifier to be created
        print(f"‚è≥ Waiting for classifier creation to complete...")
        await poller.result()
        print(f"‚úÖ Classifier '{classifier_id}' created successfully!")

        # Demonstrate URL classification using the new URL parameter
        print("\n" + "=" * 60)
        print("üåê CLASSIFYING WITH URL PARAMETER")
        print("=" * 60)

        mixed_docs_url = "https://github.com/Azure-Samples/azure-ai-content-understanding-python/raw/refs/heads/main/data/mixed_financial_docs.pdf"
        print(f"üåê Classifying document from URL: {mixed_docs_url}")

        # Begin classification operation with URL using the new URL parameter
        print(f"üîç Starting URL classification with classifier '{classifier_id}'...")
        url_classification_poller = await client.content_classifiers.begin_classify(
            classifier_id=classifier_id,
            url=mixed_docs_url,
        )

        # Wait for classification completion
        print(f"‚è≥ Waiting for URL classification to complete...")
        url_classification_result = await url_classification_poller.result()
        print(f"‚úÖ URL Classification completed successfully!")

        # Display URL classification results
        print(f"üìä URL Classification Results:")
        for content in url_classification_result.contents:
            # content is MediaContent, cast to DocumentContent for type safety
            document_content: DocumentContent = content  # type: ignore[assignment]
            print(f"   Category: {document_content.category}")
            print(f"       Start Page Number: {document_content.start_page_number}")
            print(f"       End Page Number: {document_content.end_page_number}")

        # Save the URL classification result to a file
        url_saved_file_path = save_json_to_file(
            result=url_classification_result.as_dict(),
            filename_prefix="content_classifiers_classify_url",
        )
        print(f"üíæ URL Classification result saved to: {url_saved_file_path}")

        # Demonstrate data classification using the new data parameter
        print("\n" + "=" * 60)
        print("üìÑ CLASSIFYING WITH DATA PARAMETER")
        print("=" * 60)

        # Read the mixed financial docs PDF file
        pdf_path = "sample_files/mixed_financial_docs.pdf"
        print(f"üìÑ Reading document file: {pdf_path}")
        with open(pdf_path, "rb") as pdf_file:
            pdf_content = pdf_file.read()

        # Begin classification operation with data using the new data parameter
        print(f"üîç Starting data classification with classifier '{classifier_id}'...")
        data_classification_poller = await client.content_classifiers.begin_classify(
            classifier_id=classifier_id,
            data=pdf_content,
        )

        # Wait for classification completion
        print(f"‚è≥ Waiting for data classification to complete...")
        data_classification_result = await data_classification_poller.result()
        print(f"‚úÖ Data Classification completed successfully!")

        # Display data classification results
        print(f"üìä Data Classification Results:")
        for content in data_classification_result.contents:
            # content is MediaContent, cast to DocumentContent for type safety
            document_content_data: DocumentContent = content  # type: ignore[assignment]
            print(f"   Category: {document_content_data.category}")
            print(f"       Start Page Number: {document_content_data.start_page_number}")
            print(f"       End Page Number: {document_content_data.end_page_number}")

        # Save the data classification result to a file
        data_saved_file_path = save_json_to_file(
            result=data_classification_result.as_dict(),
            filename_prefix="content_classifiers_classify_data",
        )
        print(f"üíæ Data Classification result saved to: {data_saved_file_path}")

        # Clean up the created classifier (demo cleanup)
        print(f"üóëÔ∏è  Deleting classifier '{classifier_id}' (demo cleanup)...")
        await client.content_classifiers.delete(classifier_id=classifier_id)
        print(f"‚úÖ Classifier '{classifier_id}' deleted successfully!")

    # x-ms-original-file: 2025-05-01-preview/ContentClassifiers_Classify.json
    # Manually close DefaultAzureCredential if it was used
    if isinstance(credential, DefaultAzureCredential):
        await credential.close()


if __name__ == "__main__":
    asyncio.run(main())
