# pylint: disable=line-too-long,useless-suppression

# coding=utf-8
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# Code generated by Microsoft (R) Python Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is regenerated.
# --------------------------------------------------------------------------

import asyncio
import os

from azure.ai.contentunderstanding.aio import ContentUnderstandingClient
from azure.ai.contentunderstanding.models import (
    ContentAnalyzer,
    ContentAnalyzerConfig,
    ContentFieldSchema,
    ContentFieldDefinition,
    ContentFieldType,
    GenerationMethod,
    ProcessingLocation,
)

from azure.core.credentials import AzureKeyCredential
from azure.identity.aio import DefaultAzureCredential

from dotenv import load_dotenv

load_dotenv()

"""
Prerequisites:
    pip install azure-ai-contentunderstanding python-dotenv
    az login  # Used for DefaultAzureCredential(). Alternatively, set the AZURE_CONTENT_UNDERSTANDING_KEY environment variable

Environment variables:
    AZURE_CONTENT_UNDERSTANDING_ENDPOINT   (required)
    AZURE_CONTENT_UNDERSTANDING_KEY        (optional - DefaultAzureCredential() will be used if not set)
    These variables can be set in a .env file in the samples directory for repeated use. Please see env.sample for an example.

Run:
    python update_analyzer.py
"""


async def main():
    """
    Update analyzer using update API.

    High-level steps:
    1. Create an initial analyzer
    2. Get the analyzer to verify initial state
    3. Update the analyzer with new description and tags
    4. Get the analyzer again to verify changes persisted
    5. Clean up the created analyzer
    """
    endpoint = os.getenv("AZURE_CONTENT_UNDERSTANDING_ENDPOINT") or ""
    print(f"Using endpoint: {endpoint}")
    # Return AzureKeyCredential if AZURE_CONTENT_UNDERSTANDING_KEY is set, otherwise DefaultAzureCredential
    key = os.getenv("AZURE_CONTENT_UNDERSTANDING_KEY")
    credential = AzureKeyCredential(key) if key else DefaultAzureCredential()

    async with ContentUnderstandingClient(endpoint=endpoint, credential=credential) as client:
        analyzer_id = f"sdk_sample_analyzer_for_update_{int(asyncio.get_event_loop().time())}"

        # Create initial analyzer using object model
        print(f"Creating initial analyzer '{analyzer_id}'...")

        initial_analyzer = ContentAnalyzer(
            base_analyzer_id="prebuilt-document",
            config=ContentAnalyzerConfig(
                enable_formula=True,
                enable_layout=True,
                enable_ocr=True,
                estimate_field_source_and_confidence=True,
                return_details=True,
            ),
            description=f"Initial description",
            field_schema=ContentFieldSchema(
                fields={
                    "total_amount": ContentFieldDefinition(
                        description="Total amount of this document",
                        method=GenerationMethod.EXTRACT,
                        type=ContentFieldType.NUMBER,
                    ),
                    "company_name": ContentFieldDefinition(
                        description="Name of the company",
                        method=GenerationMethod.EXTRACT,
                        type=ContentFieldType.STRING,
                    ),
                },
                description="Schema for update demo",
                name="update_demo_schema",
            ),
            models={"completion": "gpt-4o"},  # Required when using field_schema
            processing_location=ProcessingLocation.GLOBAL,
            tags={"tag1": "tag1_initial_value", "tag2": "tag2_initial_value"},
        )

        # Start the analyzer creation operation
        poller = await client.begin_create_analyzer(
            analyzer_id=analyzer_id,
            resource=initial_analyzer,
        )

        # Wait for the analyzer to be created
        print(f"Waiting for analyzer creation to complete...")
        await poller.result()
        print(f"Analyzer '{analyzer_id}' created successfully!")

        # Get the analyzer before update to verify initial state
        print(f" Getting analyzer '{analyzer_id}' before update...")
        analyzer_before_update = await client.get_analyzer(analyzer_id=analyzer_id)

        print(f"Initial analyzer state verified:")
        print(f"   Description: {analyzer_before_update.description}")
        print(f"   Tags: {analyzer_before_update.tags}")

        # Create updated analyzer with only allowed properties (description and tags)
        print(f"Creating updated analyzer configuration...")
        # Update the value for tag1, remove tag2 by setting it to an empty string, and add tag3
        updated_analyzer = ContentAnalyzer(
            # Note: Service requires baseAnalyzerId and models even in PATCH update
            # This is a service bug - TypeSpec says they should not be required in Update
            base_analyzer_id=analyzer_before_update.base_analyzer_id,  # <== SERVICE-FIX: Service will return error without this
            models=analyzer_before_update.models,  # <== SERVICE-FIX: Service will return error without this
            description=f"Updated description",
            tags={"tag1": "tag1_updated_value", "tag2": "", "tag3": "tag3_value"},
        )

        # Update the analyzer
        print(f"Updating analyzer '{analyzer_id}' with new description and tags...")
        response = await client.update_analyzer(
            analyzer_id=analyzer_id,
            resource=updated_analyzer,
        )

        print(f"Analyzer updated successfully!")

        # Get the analyzer after update to verify the changes persisted
        print(f" Getting analyzer '{analyzer_id}' after update...")
        analyzer_after_update = await client.get_analyzer(analyzer_id=analyzer_id)

        print(f"Updated analyzer state verified:")
        print(f"   Description: {analyzer_after_update.description}")
        print(f"   Tags: {analyzer_after_update.tags}")

        # Clean up the created analyzer (demo cleanup)
        print(f"Deleting analyzer '{analyzer_id}' (demo cleanup)...")
        await client.delete_analyzer(analyzer_id=analyzer_id)
        print(f"Analyzer '{analyzer_id}' deleted successfully!")

    # Manually close DefaultAzureCredential if it was used
    if isinstance(credential, DefaultAzureCredential):
        await credential.close()


# x-ms-original-file: 2025-11-01/ContentAnalyzers_Update.json
if __name__ == "__main__":
    asyncio.run(main())
