# coding=utf-8
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# Code generated by Microsoft (R) Python Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is regenerated.
# --------------------------------------------------------------------------

import asyncio
import os

from azure.ai.contentunderstanding.aio import ContentUnderstandingClient

from sample_helper import (
    get_credential,
    generate_classifier_id,
    new_simple_classifier_schema,
    extract_operation_id_from_poller,
    PollerType,
    save_response_to_file
)

from dotenv import load_dotenv

load_dotenv()

"""
Prerequisites:
    pip install azure-ai-contentunderstanding python-dotenv
    az login  # Used for DefaultAzureCredential(). Alternatively, set the AZURE_CONTENT_UNDERSTANDING_KEY environment variable

Environment variables:
    AZURE_CONTENT_UNDERSTANDING_ENDPOINT   (required)
    AZURE_CONTENT_UNDERSTANDING_KEY        (optional - DefaultAzureCredential() will be used if not set)
    These variables can be set in a .env file in the samples directory for repeated use. Please see env.sample for an example.

Run:
    python content_classifiers_get_result.py
"""


async def main():
    """
    Get classification result using get_result API.
    
    High-level steps:
    1. Create a custom classifier
    2. Classify a document to get an operation ID
    3. Extract operation ID from the classification poller
    4. Get the classification result using the operation ID
    5. Save the classification result to a file
    6. Clean up the created classifier
    """
    endpoint = os.getenv("AZURE_CONTENT_UNDERSTANDING_ENDPOINT") or ""
    credential = get_credential()

    async with ContentUnderstandingClient(endpoint=endpoint, credential=credential) as client, credential:
        classifier_id = generate_classifier_id()
        
        # Create a custom classifier using object model
        print(f"üîß Creating custom classifier '{classifier_id}'...")
        
        classifier_schema = new_simple_classifier_schema(
            classifier_id=classifier_id,
            description=f"Custom classifier for get result demo: {classifier_id}",
            tags={"demo_type": "get_result"}
        )

        # Start the classifier creation operation
        poller = await client.content_classifiers.begin_create_or_replace(
            classifier_id=classifier_id,
            resource=classifier_schema,
        )

        # Wait for the classifier to be created
        print(f"‚è≥ Waiting for classifier creation to complete...")
        await poller.result()
        print(f"‚úÖ Classifier '{classifier_id}' created successfully!")

        # Read the mixed financial docs PDF file
        pdf_path = "sample_files/mixed_financial_docs.pdf"
        print(f"üìÑ Reading document file: {pdf_path}")
        with open(pdf_path, "rb") as pdf_file:
            pdf_content = pdf_file.read()

        # Begin binary classification operation
        print(f"üîç Starting binary classification with classifier '{classifier_id}'...")
        classification_poller = await client.content_classifiers.begin_classify_binary(
            classifier_id=classifier_id,
            input=pdf_content,
            content_type="application/pdf",
        )

        # Wait for classification completion
        print(f"‚è≥ Waiting for classification to complete...")
        classification_result = await classification_poller.result()
        print(f"‚úÖ Classification completed successfully!")

        # Extract operation ID for get_result
        classification_operation_id = extract_operation_id_from_poller(classification_poller, PollerType.CLASSIFY_CALL)
        print(f"üìã Extracted classification operation ID: {classification_operation_id}")

        # Get the classification result using the operation ID
        print(f"üîç Getting classification result using operation ID '{classification_operation_id}'...")
        operation_status = await client.content_classifiers.get_result(
            operation_id=classification_operation_id,
        )
        
        print(f"‚úÖ Classification result retrieved successfully!")
        print(f"   Operation ID: {getattr(operation_status, 'id', 'N/A')}")
        print(f"   Status: {getattr(operation_status, 'status', 'N/A')}")
        
        # The actual classification result is in operation_status.result
        operation_result = getattr(operation_status, 'result', None)
        if operation_result is not None:
            print(f"   Result contains {len(getattr(operation_result, 'contents', []))} contents")
        
        # Save the classification result to a file
        saved_file_path = save_response_to_file(
            result=operation_status,
            filename_prefix="content_classifiers_get_result"
        )
        print(f"üíæ Classification result saved to: {saved_file_path}")

        # Clean up the created classifier (demo cleanup)
        print(f"üóëÔ∏è  Deleting classifier '{classifier_id}' (demo cleanup)...")
        await client.content_classifiers.delete(classifier_id=classifier_id)
        print(f"‚úÖ Classifier '{classifier_id}' deleted successfully!")


# x-ms-original-file: 2025-05-01-preview/ContentClassifiers_GetResult.json
if __name__ == "__main__":
    asyncio.run(main())
