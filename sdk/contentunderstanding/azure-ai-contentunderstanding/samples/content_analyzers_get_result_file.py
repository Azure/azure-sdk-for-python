# coding=utf-8
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# Code generated by Microsoft (R) Python Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is regenerated.
# --------------------------------------------------------------------------

import asyncio
import os
import re
from typing import Any

from azure.ai.contentunderstanding.aio import ContentUnderstandingClient
from azure.ai.contentunderstanding.models import (
    ContentAnalyzer,
    ContentAnalyzerConfig,
    FieldSchema,
    FieldDefinition,
    FieldType,
    GenerationMethod,
    AnalysisMode,
    ProcessingLocation,
)

from sample_helper import (
    get_credential, 
    extract_operation_id_from_poller, 
    PollerType,
    save_keyframe_image_to_file
)

from dotenv import load_dotenv

load_dotenv()

"""
Prerequisites:
    pip install azure-ai-contentunderstanding python-dotenv
    az login  # Used for DefaultAzureCredential(). Alternatively, set the AZURE_CONTENT_UNDERSTANDING_KEY environment variable

Environment variables:
    AZURE_CONTENT_UNDERSTANDING_ENDPOINT   (required)
    AZURE_CONTENT_UNDERSTANDING_KEY        (optional - DefaultAzureCredential() will be used if not set)
    These variables can be set in a .env file in the samples directory for repeated use. Please see env.sample for an example.

Run:
    python content_analyzers_get_result_file.py
"""


async def main():
    """
    Get result files using get_result_file API.
    
    High-level steps:
    1. Create a marketing video analyzer
    2. Analyze a video file to generate keyframes
    3. Extract operation ID from the analysis
    4. Get result files (keyframe images) using the operation ID
    5. Save the keyframe images to local files
    6. Clean up the created analyzer
    """
    endpoint = os.getenv("AZURE_CONTENT_UNDERSTANDING_ENDPOINT") or ""
    credential = get_credential()

    async with ContentUnderstandingClient(endpoint=endpoint, credential=credential) as client, credential:
        analyzer_id = f"sdk-sample-video-analyzer-{int(asyncio.get_event_loop().time())}"
        
        # Create a marketing video analyzer using object model
        print(f"ğŸ”§ Creating marketing video analyzer '{analyzer_id}'...")
        
        video_analyzer = ContentAnalyzer(
            base_analyzer_id="prebuilt-videoAnalyzer",
            config=ContentAnalyzerConfig(
                return_details=True,
            ),
            description="Marketing video analyzer for result file demo",
            mode=AnalysisMode.STANDARD,
            processing_location=ProcessingLocation.GLOBAL,
            tags={"demo_type": "video_analysis"},
        )

        # Start the analyzer creation operation
        poller = await client.content_analyzers.begin_create_or_replace(
            analyzer_id=analyzer_id,
            resource=video_analyzer,
        )

        # Extract operation ID from the poller
        operation_id = extract_operation_id_from_poller(poller, PollerType.ANALYZER_CREATION)
        print(f"ğŸ“‹ Extracted creation operation ID: {operation_id}")

        # Wait for the analyzer to be created
        print(f"â³ Waiting for analyzer creation to complete...")
        await poller.result()
        print(f"âœ… Analyzer '{analyzer_id}' created successfully!")

        # Use the FlightSimulator.mp4 video file from remote location
        video_file_url = "https://github.com/Azure-Samples/azure-ai-content-understanding-assets/raw/refs/heads/main/videos/sdk_samples/FlightSimulator.mp4"
        print(f"ğŸ“¹ Using video file from URL: {video_file_url}")
        

        # Begin video analysis operation
        print(f"ğŸ¬ Starting video analysis with analyzer '{analyzer_id}'...")
        analysis_poller = await client.content_analyzers.begin_analyze(
            analyzer_id=analyzer_id,
            url=video_file_url,
        )

        # Wait for analysis completion
        print(f"â³ Waiting for video analysis to complete...")
        analysis_result = await analysis_poller.result()
        print(f"âœ… Video analysis completed successfully!")

        # Extract operation ID for get_result_file
        analysis_operation_id = extract_operation_id_from_poller(analysis_poller, PollerType.ANALYZE_CALL)
        print(f"ğŸ“‹ Extracted analysis operation ID: {analysis_operation_id}")

        # Get the result to see what files are available
        print(f"ğŸ” Getting analysis result to find available files...")
        operation_status = await client.content_analyzers.get_result(
            operation_id=analysis_operation_id,
        )
        
        # The actual analysis result is in operation_status.result
        operation_result = operation_status.result
        if operation_result is None:
            print("âš ï¸  No analysis result available")
            return
        print(f"âœ… Analysis result contains {len(operation_result.contents)} contents")

        # Look for keyframe files in the analysis result markdown
        keyframe_files = set()
        for content in operation_result.contents:
            # Extract keyframe IDs from "markdown" if it exists and is a string
            markdown_content = getattr(content, 'markdown', '')
            if isinstance(markdown_content, str):
                # Use regex pattern to find keyframe references: (keyFrame\.d+)\.jpg
                keyframe_files.update(re.findall(r"(keyFrame\.\d+)\.jpg", markdown_content))

        if not keyframe_files:
            print("âš ï¸  No keyframe files found in the analysis result markdown")
            return

        print(f"ğŸ–¼ï¸  Found {len(keyframe_files)} keyframe files in markdown")

        # Download and save a few keyframe images (first, middle, last)
        sorted_keyframes = sorted(keyframe_files, key=lambda x: int(x.replace('keyFrame.', '')))
        if len(sorted_keyframes) >= 3:
            frames_to_download = {sorted_keyframes[0], sorted_keyframes[-1], sorted_keyframes[len(sorted_keyframes) // 2]}
        else:
            frames_to_download = set(sorted_keyframes)
        
        files_to_download = list(frames_to_download)
        print(f"ğŸ“¥ Downloading {len(files_to_download)} keyframe images: {files_to_download}")

        for keyframe_id in files_to_download:
            print(f"ğŸ“¥ Getting result file: {keyframe_id}")
            
            # Get the result file (keyframe image)
            response: Any = await client.content_analyzers.get_result_file(
                operation_id=analysis_operation_id,
                path=keyframe_id,
            )
            
            # Handle the response which may be bytes or an async iterator of bytes
            if isinstance(response, (bytes, bytearray)):
                image_content = bytes(response)
            else:
                chunks: list[bytes] = []
                async for chunk in response:
                    chunks.append(chunk)
                image_content = b"".join(chunks)

            print(f"âœ… Retrieved image file for {keyframe_id} ({len(image_content)} bytes)")
            
            # Save the image file
            saved_file_path = save_keyframe_image_to_file(
                image_content=image_content,
                keyframe_id=keyframe_id,
                test_name="content_analyzers_get_result_file",
                test_py_file_dir=os.path.dirname(os.path.abspath(__file__)),
                identifier=analyzer_id
            )
            print(f"ğŸ’¾ Keyframe image saved to: {saved_file_path}")

        # Clean up the created analyzer (demo cleanup)
        print(f"ğŸ—‘ï¸  Deleting analyzer '{analyzer_id}' (demo cleanup)...")
        await client.content_analyzers.delete(analyzer_id=analyzer_id)
        print(f"âœ… Analyzer '{analyzer_id}' deleted successfully!")


# x-ms-original-file: 2025-05-01-preview/ContentAnalyzers_GetResultFile.json
if __name__ == "__main__":
    asyncio.run(main())
