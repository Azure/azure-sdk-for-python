# coding=utf-8
# --------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# Code generated by Microsoft (R) Python Code Generator.
# Changes may cause incorrect behavior and will be lost if the code is regenerated.
# --------------------------------------------------------------------------

import asyncio
import os
from datetime import datetime
import uuid

from azure.ai.contentunderstanding.aio import ContentUnderstandingClient
from azure.ai.contentunderstanding.models import ContentClassifier, ClassifierCategory
from typing import Optional, Dict


from azure.core.credentials import AzureKeyCredential
from azure.identity.aio import DefaultAzureCredential

from dotenv import load_dotenv

load_dotenv()

"""
Prerequisites:
    pip install azure-ai-contentunderstanding python-dotenv
    az login  # Used for DefaultAzureCredential(). Alternatively, set the AZURE_CONTENT_UNDERSTANDING_KEY environment variable

Environment variables:
    AZURE_CONTENT_UNDERSTANDING_ENDPOINT   (required)
    AZURE_CONTENT_UNDERSTANDING_KEY        (optional - DefaultAzureCredential() will be used if not set)
    These variables can be set in a .env file in the samples directory for repeated use. Please see env.sample for an example.

Run:
    python content_classifiers_create_or_replace.py
"""


def new_simple_classifier_schema(
    classifier_id: str,
    description: Optional[str] = None,
    tags: Optional[Dict[str, str]] = None,
) -> ContentClassifier:
    """Create a simple ContentClassifier object with default configuration.

    Args:
        classifier_id: The classifier ID
        description: Optional description for the classifier
        tags: Optional tags for the classifier

    Returns:
        ContentClassifier: A configured ContentClassifier object
    """
    if description is None:
        description = f"test classifier: {classifier_id}"
    if tags is None:
        tags = {"test_type": "simple"}

    return ContentClassifier(
        categories={
            "Loan application": ClassifierCategory(
                description="Documents submitted by individuals or businesses to request funding, typically including personal or business details, financial history, loan amount, purpose, and supporting documentation."
            ),
            "Invoice": ClassifierCategory(
                description="Billing documents issued by sellers or service providers to request payment for goods or services, detailing items, prices, taxes, totals, and payment terms."
            ),
            "Bank_Statement": ClassifierCategory(
                description="Official statements issued by banks that summarize account activity over a period, including deposits, withdrawals, fees, and balances."
            ),
        },
        split_mode="auto",
        description=description,
        tags=tags,
    )


async def main():
    """
    Create custom classifier using begin_create_or_replace API.

    High-level steps:
    1. Create a custom classifier with defined categories
    2. Wait for classifier creation to complete
    3. Verify the classifier was created successfully
    4. Clean up the created classifier
    """
    endpoint = os.getenv("AZURE_CONTENT_UNDERSTANDING_ENDPOINT") or ""
    # Return AzureKeyCredential if AZURE_CONTENT_UNDERSTANDING_KEY is set, otherwise DefaultAzureCredential
    key = os.getenv("AZURE_CONTENT_UNDERSTANDING_KEY")
    credential = AzureKeyCredential(key) if key else DefaultAzureCredential()

    async with ContentUnderstandingClient(
        endpoint=endpoint, credential=credential
    ) as client, credential:
        classifier_id = f"sdk-sample-clf-{datetime.now().strftime('%Y%m%d')}-{datetime.now().strftime('%H%M%S')}-{uuid.uuid4().hex[:8]}"

        # Create a custom classifier using object model
        print(f"üîß Creating custom classifier '{classifier_id}'...")

        classifier_schema = new_simple_classifier_schema(
            classifier_id=classifier_id,
            description=f"Custom classifier for create demo: {classifier_id}",
            tags={"demo_type": "create", "created_by": "SDK Sample"},
        )

        # Start the classifier creation operation
        poller = await client.content_classifiers.begin_create_or_replace(
            classifier_id=classifier_id,
            resource=classifier_schema,
        )

        # Wait for the classifier to be created
        print(f"‚è≥ Waiting for classifier creation to complete...")
        result = await poller.result()
        print(f"‚úÖ Classifier '{classifier_id}' created successfully!")

        # Display classifier details
        print(f"üìã Classifier Details:")
        print(f"   ID: {getattr(result, 'classifier_id', 'N/A')}")
        print(f"   Description: {getattr(result, 'description', 'N/A')}")
        print(f"   Status: {getattr(result, 'status', 'N/A')}")
        print(f"   Created at: {getattr(result, 'created_at', 'N/A')}")

        # Check if categories exist
        categories = getattr(result, "categories", None)
        if categories:
            print(f"   Categories: {len(categories)} categories")
            for category_name, category in categories.items():
                description = getattr(category, "description", "No description")
                print(f"     - {category_name}: {description}")
        else:
            print(f"   Categories: Not available")

        # Next steps:
        # - To retrieve the classifier: see content_classifiers_get_classifier.py
        # - To use the classifier for classification: see content_classifiers_classify_binary.py
        # - To delete the classifier: see content_classifiers_delete_classifier.py

        # Clean up the created classifier (demo cleanup)
        print(f"üóëÔ∏è  Deleting classifier '{classifier_id}' (demo cleanup)...")
        await client.content_classifiers.delete(classifier_id=classifier_id)
        print(f"‚úÖ Classifier '{classifier_id}' deleted successfully!")


# x-ms-original-file: 2025-05-01-preview/ContentClassifiers_CreateOrReplace.json
if __name__ == "__main__":
    asyncio.run(main())
