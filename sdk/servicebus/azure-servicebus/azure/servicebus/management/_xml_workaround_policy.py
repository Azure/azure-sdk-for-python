# --------------------------------------------------------------------------------------------
# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License. See License.txt in the project root for license information.
# --------------------------------------------------------------------------------------------

import time
import six
from azure.core.pipeline import PipelineRequest
from azure.core.pipeline.policies import SansIOHTTPPolicy
from .._base_handler import ServiceBusSharedKeyCredential


class ServiceBusXMLWorkaroundPolicy(SansIOHTTPPolicy):
    """A policy that put token generated by ServiceBusSharedKeyCredential into HTTP request header

    :param str endpoint:
    :param ServiceBusSharedKeyCredential credential:
    :param str name:
    """
    def __init__(self):
        # type: () -> None
        super(ServiceBusXMLWorkaroundPolicy, self).__init__()

    def on_request(self, request):
        # type: (PipelineRequest) -> None
        """Mutate QueueDescription serialized XML to use default namespace

        :param request: The pipeline request object
        :type request: ~azure.core.pipeline.PipelineRequest
        """
        request_body = request.http_request.body
        if request_body and b'<ns1:QueueDescription>' in request_body:
            request_body = request_body.replace(b'ns1:', b'')
            request_body = request_body.replace(b':ns1', b'')
            request.http_request.body = request_body
            request.http_request.data = request_body
