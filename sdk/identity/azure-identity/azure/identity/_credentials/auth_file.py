# ------------------------------------
# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.
# ------------------------------------
import json

from .client_credential import ClientSecretCredential
from azure.core.exceptions import ClientAuthenticationError


def _parse_credentials_file(file_path):
    with open(file_path, 'r') as f:
        auth_str = f.read()
        
    return json.loads(auth_str)


class AuthFileCredential(object):
    """Authenticates using configuration stored in an Azure SDK Auth File.

    An Azure SDK Auth file may be generated by passing ``--sdk-auth`` when generating a service principal 
    with ``az ad sp create-for-rbac``. At this time only supports Auth Files which contain a client secret,
    client certificates are not supported.

    :param str file_path: Path to the Azure SDK Auth File.
    """

    def __init__(self, file_path, **kwargs):
        # type: (str, **Any) -> None
        self._credential = None
        self._file_path = file_path
        self._kwargs = kwargs.copy()

    def get_token(self, *scopes, **kwargs):  # pylint:disable=unused-argument
        # type: (*str, **Any) -> AccessToken
        """Request an access token for ``scopes``.

        The first time this method is called, the credential will instantiate a :class:`~azure.identity.ClientSecretCredential` 
        as its inner credential with credential values from an auth file before requesting an access token with the inner credential.

        :param str scopes: desired scopes for the access token
        :rtype: :class:`azure.core.credentials.AccessToken`
        :raises ~azure.core.exceptions.ClientAuthenticationError:
        """

        self._ensure_credential()
        return self._credential.get_token(*scopes, **kwargs)

    def _ensure_credential(self):
        if self._credential is None:
            try:
                self._credential = self._build_credential_for_creds_file(_parse_credentials_file(self._file_path))
            except IOError as e:
                raise ClientAuthenticationError('No file found on the given path "{}"'.format(self._file_path))
            except Exception as parse_e:
                raise ClientAuthenticationError('Error parsing SDK Auth File "{}"'.format(self._file_path))

    def _build_credential_for_creds_file(self, auth_data):
        client_id = auth_data.get('clientId')
        client_secret = auth_data.get('clientSecret')
        tenant_id = auth_data.get('tenantId')
        active_directory_endpoint_url = auth_data.get('activeDirectoryEndpointUrl')

        if not all((client_id, client_secret, tenant_id, active_directory_endpoint_url)):
            raise ClientAuthenticationError("Malformed Azure SDK Auth file. The file should contain "
                "'clientId', 'clientSecret', 'tenantId' and 'activeDirectoryEndpointUrl' values.")
        
        return ClientSecretCredential(tenant_id, client_id, client_secret, authority=active_directory_endpoint_url, **self._kwargs)
