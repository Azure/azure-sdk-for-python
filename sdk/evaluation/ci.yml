# NOTE: Please refer to https://aka.ms/azsdk/engsys/ci-yaml before editing this file.

trigger:
  branches:
    include:
    - main
    - feature/*
    - hotfix/*
    - release/*
  paths:
    include:
    - sdk/evaluation

pr:
  branches:
    include:
    - main
    - feature/*
    - hotfix/*
    - release/*
  paths:
    include:
    - sdk/evaluation

extends:
  template: ../../eng/pipelines/templates/stages/archetype-sdk-client.yml
  parameters:
    ServiceDirectory: evaluation
    TestProxy: true
    # This custom matrix config should be dropped once:
    #  * Once azure-ai-ml supports 3.13 (currently crashes due to type annotation)
    MatrixConfigs:
      - Name: ai_ci_matrix
        Path: sdk/evaluation/platform-matrix.json
        Selection: sparse
        GenerateVMJobs: true
    MatrixFilters:
      - PythonVersion=^(?!3\.14)
    Artifacts:
    - name: azure-ai-evaluation
      safeName: azureaievaluation
    # Run red team tests for the dedicated redteam job
    AfterTestSteps:
      - pwsh: |
          if ("$(IsRedteamJob)" -eq "true") {
            Write-Host "Running red team tests with dev_requirements_redteam.txt..."
            $packageDir = "$(Build.SourcesDirectory)/sdk/evaluation/azure-ai-evaluation"

            # Install redteam requirements
            python -m pip install -r "$packageDir/dev_requirements_redteam.txt"

            # Install the package with redteam extra
            python -m pip install -e "$packageDir[redteam]"

            # Run redteam unit tests
            Write-Host "Running red team unit tests..."
            python -m pytest "$packageDir/tests/unittests/test_redteam" -v --tb=short

            # Run redteam e2e tests
            Write-Host "Running red team e2e tests..."
            python -m pytest "$packageDir/tests/e2etests" -v --tb=short -k "red_team or redteam or foundry"
          } else {
            Write-Host "Skipping red team tests (not a redteam job)"
          }
        displayName: 'Run Red Team Tests'
        condition: eq(variables['IsRedteamJob'], 'true')
