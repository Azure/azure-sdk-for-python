trigger: none

pr:
  branches:
    include:
    - master
    - feature/*
    - hotfix/*
    - release/*
    - restapi*
  paths:
    include:
    - sdk/cosmos

jobs:
  - job: 'Emulator'

    timeoutInMinutes: 120
    continueOnError: false
    strategy:
      maxParallel: 1
      matrix:
        Windows_Python35:
          OSVmImage: 'windows-2019'
          PythonVersion: '3.5'
        Windows_Python27:
          OSVmImage: 'windows-2019'
          PythonVersion: '2.7'

    pool:
      vmImage: $(OSVmImage)

    steps:
      - task: UsePythonVersion@0
        displayName: 'Use Python $(PythonVersion)'
        inputs:
          versionSpec: $(PythonVersion)

      - script: |
          python -m pip install --upgrade pip
          pip install setuptools --upgrade
          python scripts/dev_setup.py --packageList azure-cosmos
        displayName: 'Set up Environment'

      - task: PowerShell@1
        displayName: 'Run Python Tests'
        inputs:
          scriptType: inlineScript
          inlineScript: |
            pytest --junitxml=sdk/cosmos/azure-cosmos/Test-junit.xml --verbose sdk/cosmos/azure-cosmos/test -k "not globaldb"
        env:
          ACCOUNT_KEY: $(python-cosmos-live-account-key)
          ACCOUNT_HOST: $(python-cosmos-live-account-host)
        condition: succeededOrFailed()

      - task: PublishTestResults@2
        displayName: 'Publish Python Test Results'
        inputs:
          testResultsFiles: '**\TEST-*.xml'
          testRunTitle: 'Cosmos $(OSName) Node $(PythonVersion) - Python'
