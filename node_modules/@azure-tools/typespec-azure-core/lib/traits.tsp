import "@typespec/versioning";

namespace Azure.Core.Traits;

using TypeSpec.Reflection;
using TypeSpec.Versioning;

/**
 * Enumerates the standard trait locations for Azure.Core operations.
 */
@added(Azure.Core.Versions.v1_0_Preview_2)
@doc("Enumerates the standard trait locations for Azure.Core operations.")
enum TraitLocation {
  @doc("Identifies operation parameters as the trait target.")
  Parameters,

  @doc("Identifies operation response as the trait target.")
  Response,

  @doc("Identifies the API version parameter as the trait target.")
  ApiVersionParameter,
}

/**
 * Enumerates the standard trait contexts for Azure.Core operations.
 */
@added(Azure.Core.Versions.v1_0_Preview_2)
@doc("")
enum TraitContext {
  @doc("Trait is applicable for resource 'read' operations.")
  Read,

  @doc("Trait is applicable for resource 'create' operations.")
  Create,

  @doc("Trait is applicable for resource 'update' operations.")
  Update,

  @doc("Trait is applicable for resource 'delete' operations.")
  Delete,

  @doc("Trait is applicable for resource 'list' operations.")
  List,

  @doc("Trait is applicable for resource actions.")
  Action,
}

/**
 * Used to override a trait.
 * @template Trait The trait to override.
 */
@added(Azure.Core.Versions.v1_0_Preview_2)
@Private.applyTraitOverride(Trait)
model TraitOverride<Trait> {}

/**
 * Declares a trait that is applied as a query parameter.
 * @template TParams The name of the query parameter.
 * @template Contexts The contexts in which the trait is applicable.
 */
@trait
@added(Azure.Core.Versions.v1_0_Preview_2)
@Private.ensureAllQueryParams(TParams)
model QueryParametersTrait<TParams, Contexts = unknown> {
  @traitContext(Contexts)
  queryParams: {
    @traitLocation(TraitLocation.Parameters)
    parameters: TParams;
  };
}

/**
 * Declares a trait that is applied as a query parameter for list operations.
 * @template TParams Object describing the query parameters.
 */
@trait
@added(Azure.Core.Versions.v1_0_Preview_2)
model ListQueryParametersTrait<TParams> is QueryParametersTrait<TParams, TraitContext.List>;

/**
 * Declares a trait that is applied as a request header parameter.
 * @template THeaders Object describing the request header parameters.
 * @template Contexts The contexts in which the trait is applicable.
 */
@trait
@added(Azure.Core.Versions.v1_0_Preview_2)
@Private.ensureAllHeaderParams(THeaders)
model RequestHeadersTrait<THeaders, Contexts = unknown> {
  @traitContext(Contexts)
  requestHeaders: {
    @traitLocation(TraitLocation.Parameters)
    parameters: THeaders;
  };
}

/**
 * Declares a trait that is applied as a response header parameter.
 * @template THeaders Object describing the response header parameters.
 * @template Contexts The contexts in which the trait is applicable.
 */
@trait
@added(Azure.Core.Versions.v1_0_Preview_2)
@Private.ensureAllHeaderParams(THeaders)
model ResponseHeadersTrait<THeaders, Contexts = unknown> {
  @traitContext(Contexts)
  responseHeaders: {
    @traitLocation(TraitLocation.Response)
    parameters: THeaders;
  };
}

/**
 * Declares a version parameter trait.
 * @template TVersionParameter The type of the version parameter.
 */
@trait("VersionParameter")
@added(Azure.Core.Versions.v1_0_Preview_2)
model VersionParameterTrait<TVersionParameter> {
  versionParameter: {
    @traitLocation(TraitLocation.ApiVersionParameter)
    apiVersionParam: TVersionParameter;
  };
}

/**
 * Provides clientRequestId headers for requests and responses.
 * @template TVersionAdded The version when the trait was added to the specification.
 *           Leave this empty if the trait is always supported.
 */
@trait("ClientRequestId")
@traitAdded(TVersionAdded)
model SupportsClientRequestId<TVersionAdded extends EnumMember | null = null> {
  #suppress "@azure-tools/typespec-providerhub/no-inline-model" "This inline model is never used directly in operations."
  clientRequestId: {
    @traitLocation(TraitLocation.Parameters)
    parameters: ClientRequestIdHeader;

    @traitLocation(TraitLocation.Response)
    response: ClientRequestIdHeader;
  };
}

/**
 * Indicates that the service or operation does not support clientRequestId headers.
 */
@trait("ClientRequestId")
model NoClientRequestId {
  clientRequestId: {};
}

/**
 * Provides conditional request headers for requests and ETag headers for responses.
 * @template TVersionAdded The version when the trait was added to the specification.
 *           Leave this empty if the trait is always supported.
 */
@trait("ConditionalRequests")
@traitAdded(TVersionAdded)
model SupportsConditionalRequests<TVersionAdded extends EnumMember | null = null> {
  #suppress "@azure-tools/typespec-providerhub/no-inline-model" "This inline model is never used directly in operations."
  @traitContext(TraitContext.Read)
  conditionalRequests: {
    @traitLocation(TraitLocation.Parameters)
    parameters: ConditionalRequestHeaders;

    @traitLocation(TraitLocation.Response)
    response: EtagResponseEnvelope;
  };
}

/**
 * Indicates that the service or operation does not support conditional requests.
 */
@trait("ConditionalRequests")
model NoConditionalRequests {
  conditionalRequests: {};
}

/**
 * Provides repeatable request headers for requests and responses.
 * @template TVersionAdded The version when the trait was added to the specification.
 *           Leave this empty if the trait is always supported.
 */
@trait("RepeatableRequests")
@traitAdded(TVersionAdded)
model SupportsRepeatableRequests<TVersionAdded extends EnumMember | null = null> {
  #suppress "@azure-tools/typespec-providerhub/no-inline-model" "This inline model is never used directly in operations."
  @traitContext(
    TraitContext.Create | TraitContext.Update | TraitContext.Delete | TraitContext.Action
  )
  repeatableRequests: {
    @traitLocation(TraitLocation.Parameters)
    parameters: RepeatabilityRequestHeaders;

    @traitLocation(TraitLocation.Response)
    response: RepeatabilityResponseHeaders;
  };
}

/**
 * Indicates that the service or operation does not support repeatable requests.
 */
@trait("RepeatableRequests")
model NoRepeatableRequests {
  repeatableRequests: {};
}

/**
 * `@trait` marks a model type as representing a 'trait' and performs basic validation
 * checks.
 *
 * @param target The model type to mark as a trait.
 * @param traitName An optional name to uniquely identify the trait.  If unspecified,
 *        the model type name is used.
 */
extern dec trait(target: unknown, traitName?: valueof string);

/**
 * `@traitContext` sets the applicable context for a trait on its envelope property.
 *
 * @param target The trait envelope property where the context will be applied.
 * @param contexts An enum member or union of enum members representing the trait's
 *        applicable contexts.
 */
extern dec traitContext(target: ModelProperty, contexts: EnumMember | Union | unknown);

/**
 * `@traitLocation` sets the applicable location for a trait on its envelope property.
 *
 * @param target The trait envelope property where the context will be applied.
 * @param contexts An enum member or union of enum members representing the trait's
 *        applicable contexts.
 */
extern dec traitLocation(target: ModelProperty, contexts: EnumMember);

/**
 * Sets the version for when the trait was added to the specification.  Can be applied
 * to either a trait model type or its envelope property.
 * @param addedVersion The enum member representing the service version.
 */
extern dec traitAdded(target: Model | ModelProperty, addedVersion: EnumMember | null);

namespace Azure.Core.Traits.Private {
  @added(Azure.Core.Versions.v1_0_Preview_2)
  @Private.addTraitProperties(Traits, Location, Contexts)
  model TraitProperties<
    Traits extends Model,
    Location extends TypeSpec.Reflection.EnumMember,
    Contexts = unknown
  > {}

  @doc("Contains the details of a specific trait expected by an interface or operation.")
  model ExpectedTrait {
    @doc("The name of the expected trait.")
    trait: string;

    @doc("The error message to be displayed when the trait is not present.")
    message: string;
  }
}

// These decorators are not meant to be used by TypeSpec authors
namespace Azure {
  namespace Core {
    namespace Traits {
      namespace Private {
        /**
         * `@traitSource` stores the `traitName` of its original trait on the envelope property.
         *
         * @param target The trait envelope property where `traitName` will be stored.
         * @param traitName The name of the original trait to which this property belongs.
         */
        extern dec traitSource(target: ModelProperty, traitName: valueof string);

        /**
         * Copies trait properties from `traitModel` into `target` which conform to the
         * specified location and contexts.
         * @param traitModel The trait model type to be applied.
         * @param traitLocation The trait location to use for selecting trait properties.
         * @param traitContexts The trait contexts to use for selecting trait properties.
         */
        extern dec addTraitProperties(
          target: Model,
          traitModel: Model,
          traitLocation: EnumMember,
          traitContexts: EnumMember | Union | unknown
        );

        /**
         * `@applyTraitOverride` copies the `traitModel` into `target` and renames its envelope
         * property to enable the trait to override another trait sharing the same name.
         *
         * @param target The model into which the trait will be copied.
         * @param traitModel The trait model type to be overridden.
         */
        extern dec applyTraitOverride(target: unknown, traitModel: unknown);

        /**
         * `@ensureTraitsPresent` checks the envelope properties of `traitModel` to ensure all
         * of the `expectedTraits` are present as envelope properties.
         *
         * @param target The interface or operation where the `traitModel` should be checked.
         * @param traitModel The trait model type to check.
         * @param expectedTraits The array of `ExpectedTrait` models which describe each expected trait.
         */
        extern dec ensureTraitsPresent(
          target: Interface | TypeSpec.Reflection.Operation,
          traitModel: unknown,
          expectedTraits: ExpectedTrait[]
        );

        /**
         * `@ensureAllQueryParams` checks the properties of `paramModel` to ensure they all are marked
         * with the `@query` decorator.
         *
         * @param target The model type where this check will be established.
         * @param paramModel The actual model type to check for query parameters.
         */
        extern dec ensureAllQueryParams(target: unknown, paramModel: unknown);

        /**
         * `@ensureAllHeaderParams` checks the properties of `paramModel` to ensure they all are marked
         * with the `@header` decorator.
         *
         * @param target The model type where this check will be established.
         * @param paramModel The actual model type to check for header properties.
         */
        extern dec ensureAllHeaderParams(target: unknown, paramModel: unknown);
      }
    }
  }
}
